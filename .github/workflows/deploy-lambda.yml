name: Deploy Lambda (Go) - no-snapstart

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.LAMBDA_S3_BUCKET }}           # e.g. kamleshdeploy
      S3_KEY: hypershop/hypershop-go-lambda.zip
      ZIP_PATH: target/hypershop-go-lambda.zip
      FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}   # e.g. hypershop_go
      ALIAS_NAME: prod
      GO_VERSION: 1.25.5

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}   # store role ARN in secrets
          aws-region: ${{ env.AWS_REGION }}

      - name: Disable SnapStart for function (ensure none)
        run: |
          aws lambda update-function-configuration \
            --function-name "${FUNCTION_NAME}" \
            --snap-start ApplyOn=None || true
        # we use || true so job won't fail if permission/feature not applicable

      - name: Prepare target folder
        run: mkdir -p "$ZIP_PATH" || true

      - name: Build Go Lambda binary (linux)
        run: |
          export GOOS=linux
          export GOARCH=amd64       # change to arm64 if you use Graviton
          export CGO_ENABLED=0
          go build -trimpath -ldflags "-s -w" -o bootstrap ./cmd/lambda

      - name: Zip the bootstrap (create lambda package)
        run: |
          mkdir -p "$(dirname "$ZIP_PATH")"
          zip -j "$ZIP_PATH" bootstrap
          ls -lh "$ZIP_PATH"

      - name: Upload Lambda zip to S3
        run: |
          aws s3 cp "$ZIP_PATH" "s3://${S3_BUCKET}/${S3_KEY}"

      - name: Update Lambda code and publish
        run: |
          set -euo pipefail

          VERSION=$(aws lambda update-function-code \
            --function-name "${FUNCTION_NAME}" \
            --s3-bucket "${S3_BUCKET}" \
            --s3-key "${S3_KEY}" \
            --publish \
            --query 'Version' \
            --output text)

          echo "Published version: ${VERSION}"

          # If alias exists -> update, else create
          if aws lambda get-alias --function-name "${FUNCTION_NAME}" --name "${ALIAS_NAME}" >/dev/null 2>&1; then
            aws lambda update-alias \
              --function-name "${FUNCTION_NAME}" \
              --name "${ALIAS_NAME}" \
              --function-version "${VERSION}"
            echo "Alias ${ALIAS_NAME} updated to version ${VERSION}"
          else
            aws lambda create-alias \
              --function-name "${FUNCTION_NAME}" \
              --name "${ALIAS_NAME}" \
              --function-version "${VERSION}"
            echo "Alias ${ALIAS_NAME} created for version ${VERSION}"
          fi

      - name: Debug - who am i
        run: |
          go version
          aws sts get-caller-identity
